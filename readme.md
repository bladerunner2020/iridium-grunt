# Grunt-скрипт для сборки проекта i3pro Iridium Mobile

## Введение

**gruntfile.js** содержит grunt-скрипт для сборки проекта **i3pro Iridium Mobile**. Он предназначен для того, чтобы можно
было создавать скрипты для проетов **Iridium Mobile** во внешних IDE-средах (например, WebStorm), создавать универсальные
js-модули, которые можно использовать в разных проектах, использовать механизм контроля версий, автоматической нумерации
версий проекта, сборки проекта из IDE.

### Файловая струкутура проекта

Фаловая структура проекта должна выглядить следующим образом:

```
GreatIridiumProject
│   gruntfile.js
│   package.json
│
└─── project
│   │   GreatIridiumProject.irpz
│
└─── scripts
│   │   localscript1.js
│   │   localscript2.js
│   │   ...
│
└─── temp
│
└─── build
│
└─── node_modules

```

В корень проекта помещаются файлы **gruntfile.js** и **package.json**, в папку **project** нужно положить файл с проектом **.irpz** или
**.sirpz**, в папку **scripts** вы помещаете локальные скрипты проекта.

Спиосок локальных скриптов проекта должен быть прописан в файле **package.json** в раздел **projectScripts**.

Папки **temp** и **build** создаются автоматически grunt скриптом. Папка **node_modules** создается утилитой **npm**.

### Требования к проекту i3pro

В файле проекта (панельный или серверный) необходимо добавить пустой скрипт **main.js**.

Файл проекта и скрипт **main.js** не должны быть защищены паролем.

Файл проекта должен быть помещен в папку **project**.

Рекомендуется создать токен проекта **AppVersion** (можно назвать по-другому).


### Файл package.json

Для создания начального файла **package.json** нужно в корневой папке проекта выполнить команду:

```
npm init
```

При сборке проекта Iridium будут задействованы разделы **dependencies** (стандартный раздел) и **projectScripts**
(раздел добавляемый вручную).

В разделе **dependencies** будут находиться глобальные модули, которые загружаются из репозитория. Предположим есть
некоторый универсальный модуль - драйвер проектора NEC, который используется в разных проектах. Для установки этого модуля
используется команда:

 ```
 npm install <git repo url> --save
 ```

Здесь **git repo url** будет вести к git-репозиторию, где хранится модуль. После запуска этой команды модуль будет загружен из
репозитория в папку **node_modules** и добавле в раздел **dependencies** файла **package.json**.

В разделе **projectScripts** ()создается в файле **package.json** вручную) нужно прописать все локальные скрипты, которые
помещаются в папку **scripts**.

 ```
  "projectScripts": [
    "scripts/localscript1.js",
    "scripts/localscript2.js",
    ...
  ]
   ```

Если предполагается, что модули зависят друг от друга важно соблюсти правильную последовательность модулей в разделах
**dependencies** и **projectScripts**.

В разделе **devDependencies** находятся js-модули, которые используются для работы **grunt**.

### Принцип работы

Сборка проекта осуществляется следующим образом:
- удаляется содержимое папок **temp** и **build**
- увеличивается номер версии в файле **package.json**
- файл проекта **.irpz** или **.sirpz** копируется в папку **temp**, переименовывается в **.zip** и разархивируется
- берутся файлы **index.js** из глобальных модулей (находятся в **node_modules/<iridium_module>**) и локальные скрипты и
объединяется в файл **main.js**, который помещается в папку **temp/scripts/**
- в **main.js** ищется строка **'{{ VERSION }}'** и заменяется на текущую версию из папки **package.json**
- проект в папке **temp** архивируется в zip, переименовывается в **.irpz** или **.sirps** и копируется в папку **build**.


## Установка

1. Установить [Node JS](https://nodejs.org/)
2. Создать файловую струкутру, как указано выше
3. Сгенерировать начальный проект, командой **npm init** (будет создан начальный файл **package.json**)
4. Скачать файл **gruntfile.js** в корень проекта
4. Создать в нем раздел **devDependencies**:

 ```
  "devDependencies": {
    "grunt": "^1.0.1",
    "grunt-bump": "^0.8.0",
    "grunt-contrib-clean": "^1.1.0",
    "grunt-contrib-compress": "^1.4.3",
    "grunt-contrib-concat": "^1.0.1",
    "grunt-contrib-copy": "^1.0.0",
    "grunt-contrib-uglify": "^3.2.1",
    "grunt-file-exists": "^0.1.4",
    "grunt-rename": "^0.1.4",
    "grunt-string-replace": "^1.3.1",
    "grunt-strip-code": "^1.0.6",
    "grunt-version": "^1.2.1",
    "grunt-zip": "^0.17.1",
  }
   ```
 Это можно сделать вручную, скопировав код в **package.json** либо исопльзуя команду:

 ```
 npm install grunt --save-dev
 npm install grunt-bump --save-dev
 npm install grunt-contrib-clean --save-dev
 ...
 ```

 Если разел создается вручную, то после этого нужно запустить команду:
  ```
  npm install
  ```

5. Добавить локальные скрипты в раздел **projectScripts** и установить глобальные модули (см. выше)

## Сборка проекта

Для сборки проекта необходимо запустить команду:

  ```
  grunt build --project=GreatIridiumProject
  ```

Вместо **GreatIridiumProject**, конечно, подставляется имя проекта.

В процессе разработки иногода бывает нужным згенерирвать только скрипт **main.js**, но не собирать весь проект. Например,
для отладки бывает удобней и быстрей генерирвать **main.js** и копировать его в проект через буфер обмена. Для генерации только
скрипта **main.js** используется команда:

  ```
  grunt build_script --project=GreatIridiumProject
  ```

Для сборки проекта без генерации скрипта (например, если вы внесли какие-то изменения в **main.js** для отладки):

  ```
  grunt build_from_temp --project=GreatIridiumProject
  ```

Для сборки релиза (при сборке релиза скрипт **main.js** делается нечитаемым, командой **uglify**):

  ```
  grunt build_release --project=GreatIridiumProject
  ```

## Авторы

* Александр Пивоваров aka Bladerunner2020 (pivovarov@gmail.comx )